{"version":3,"file":"core.esm.js","sources":["../../src/harness/core.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { HarnessIntegrationConfig } from './config';\n\n/**\n * Given a URL pointing to a file, returns a URL\n * for editing the contents of the data.\n *\n * @remarks\n *\n * Converts\n * from: https://app.harness.io/a/b/src/branchname/path/to/c.yaml\n * or:   https://app.harness.io/a/b/_edit/branchname/path/to/c.yaml\n *\n * @param url - A URL pointing to a file\n * @param config - The relevant provider config\n * @public\n */\nexport function getHarnessEditContentsUrl(\n  config: HarnessIntegrationConfig,\n  url: string,\n) {\n  const parsedUrl = parseHarnessUrl(config, url);\n  return `${parsedUrl.baseUrl}/ng/account/${parsedUrl.accountId}/module/code/orgs/${parsedUrl.orgName}/projects/${parsedUrl.projectName}/repos/${parsedUrl.repoName}/files/${parsedUrl.branch}/~/${parsedUrl.path}`;\n}\n\n/**\n * Given a file path URL,\n * it returns an API URL which returns the contents of the file .\n * @remarks\n *\n * Converts\n * from: https://app.harness.io/ng/account/accountId/module/code/orgs/orgName/projects/projName/repos/repoName/files/refMain/~/all-apis.yaml\n * to:   https://app.harness.io/gateway/code/api/v1/repos/accountId/orgName/projName/repoName/+/content/all-apis.yaml?routingId=accountId&include_commit=false&ref=refMain\n *\n * @param url - A URL pointing to a file\n * @param config - The relevant provider config\n * @public\n */\nexport function getHarnessFileContentsUrl(\n  config: HarnessIntegrationConfig,\n  url: string,\n) {\n  const parsedUrl = parseHarnessUrl(config, url);\n  return `${parsedUrl.baseUrl}/gateway/code/api/v1/repos/${parsedUrl.accountId}/${parsedUrl.orgName}/${parsedUrl.projectName}/${parsedUrl.repoName}/+/raw/${parsedUrl.path}?routingId=${parsedUrl.accountId}&git_ref=refs/heads/${parsedUrl.refString}`;\n}\n\n/**\n * Given a URL pointing to a repository/path, returns a URL\n * for archive contents of the repository.\n *\n * @remarks\n *\n * Converts\n * from: https://qa.harness.io/ng/account/accountId/module/code/orgs/orgId/projects/projectName/repos/repoName/files/branch/~/fileName\n * to:   https://qa.harness.io/gateway/code/api/v1/repos/accountId/orgId/projectName/repoName/+/archive/branch.zip?routingId=accountId\n *\n * @param url - A URL pointing to a repository/path\n * @param config - The relevant provider config\n * @public\n */\nexport function getHarnessArchiveUrl(\n  config: HarnessIntegrationConfig,\n  url: string,\n) {\n  const parsedUrl = parseHarnessUrl(config, url);\n  return `${parsedUrl.baseUrl}/gateway/code/api/v1/repos/${parsedUrl.accountId}/${parsedUrl.orgName}/${parsedUrl.projectName}/${parsedUrl.repoName}/+/archive/${parsedUrl.branch}.zip?routingId=${parsedUrl.accountId}`;\n}\n\n/**\n * Given a URL pointing to a repository branch, returns a URL\n * for latest commit information.\n *\n * @remarks\n *\n * Converts\n * from: https://app.harness.io/ng/account/accountId/module/code/orgs/orgName/projects/projectName/repos/repoName/files/branchName\n * to:   https://app.harness.io/gateway/code/api/v1/repos/accountId/orgName/projectName/repoName/+/content?routingId=accountId&include_commit=true&git_ref=refs/heads/branchName\n *\n * @param url - A URL pointing to a repository branch\n * @param config - The relevant provider config\n * @public\n */\nexport function getHarnessLatestCommitUrl(\n  config: HarnessIntegrationConfig,\n  url: string,\n) {\n  const parsedUrl = parseHarnessUrl(config, url);\n  return `${parsedUrl.baseUrl}/gateway/code/api/v1/repos/${parsedUrl.accountId}/${parsedUrl.orgName}/${parsedUrl.projectName}/${parsedUrl.repoName}/+/content?routingId=${parsedUrl.accountId}&include_commit=true&git_ref=refs/heads/${parsedUrl.branch}`;\n}\n\n/**\n * Return request headers for a Harness Code provider.\n *\n * @param config - A Harness Code provider config\n * @public\n */\nexport function getHarnessRequestOptions(config: HarnessIntegrationConfig): {\n  headers?: Record<string, string>;\n} {\n  const headers: Record<string, string> = {};\n  const { token, apiKey } = config;\n\n  if (apiKey) {\n    headers['x-api-key'] = apiKey;\n  } else if (token) {\n    headers.Authorization = `Bearer ${token}`;\n  }\n\n  return {\n    headers,\n  };\n}\n\n/**\n * Return parsed git url properties.\n *\n * @param config - A Harness provider config\n * @param url - A URL pointing to a repository\n * @public\n */\nexport function parseHarnessUrl(\n  config: HarnessIntegrationConfig,\n  url: string,\n): {\n  baseUrl: string;\n  accountId: string;\n  orgName: string;\n  projectName: string;\n  refString: string;\n  repoName: string;\n  path: string;\n  refDashStr: string;\n  branch: string;\n} {\n  const baseUrl = `https://${config.host}`;\n  try {\n    const pathUrl = new URL(url);\n    const pathSegments = pathUrl.pathname\n      .split('/')\n      .filter(segment => segment !== '');\n    const urlParts = pathUrl.pathname.split('/');\n    const [\n      _ng,\n      _account,\n      accountId,\n      _module,\n      _moduleName,\n      _org,\n      orgName,\n      _projects,\n      projectName,\n      _repos,\n      repoName,\n      _files,\n      _ref,\n      _branch,\n      ..._path\n    ] = pathSegments;\n    const refAndPath = urlParts.slice(\n      urlParts.findIndex(i => i === 'files' || i === 'edit') + 1,\n    );\n    const refIndex = refAndPath.findIndex(item => item === '~');\n    const refString = refAndPath.slice(0, refIndex).join('/');\n    const pathWithoutSlash =\n      refIndex !== -1\n        ? refAndPath\n            .slice(refIndex + 1)\n            .join('/')\n            .replace(/^\\//, '')\n        : '';\n    return {\n      baseUrl: baseUrl,\n      accountId: accountId,\n      orgName: orgName,\n      projectName: projectName,\n      refString: refString,\n      path: pathWithoutSlash,\n      repoName: repoName,\n      refDashStr: refAndPath.slice(0, refIndex).join('-'),\n      branch:\n        refIndex !== -1\n          ? refAndPath.slice(0, refIndex).join('/')\n          : refAndPath.join('/'),\n    };\n  } catch (e) {\n    throw new Error(`Incorrect URL: ${url}, ${e}`);\n  }\n}\n"],"names":[],"mappings":"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"}